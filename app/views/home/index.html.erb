<div class='title_tools'>
  <button class="btn btn-success" type="button">
    Termos Fechados Hoje: &nbsp; <span class="badge"> <%= @count_contracts_day %> </span>
  </button>
  <button class="btn btn-primary" type="button">
    Termos Fechados no MES: &nbsp; <span class="badge"> <%= @count_contracts_month %> </span>
  </button>
  <a class="btn btn-large btn-default" <%= link_to(t('menu.search'), root_path ) %> </a>
</div>

<div class='title_page'>
  <span> <%= current_user.client? ? t('home.title_client') : 'Dashboard de ' << current_user.name.upcase %> </span>
</div>

<% if @taxpayer %>
  <div class='title'>
    <br>
    <span> <%= 'Informações sobre Contribuinte - ' << @taxpayer.name.upcase %> </span>
  </div>
<% end %>

<% if @taxpayer.nil? %>
  <% if current_user.admin? || current_user.user? %>
    <br>
    <%= render "calendar" %>
    <br>
  <% end %>

  <div class='subtitle'> <%= t('home.search.title') %> </div>
  <div class='section'>
    <%= bootstrap_form_tag url: filter_name_home_index_path, method: 'get', layout: :inline do |f| %>
      <%= f.search_field :name, placeholder: 'Procure pelo nome do contribuinte...', size: 70, skip_label: true %>
      <%= f.search_field :cna, placeholder: 'Procure pelo CNA...', size: 20, skip_label: true %> 
      <%= f.search_field :cpf, placeholder: 'Procure pelo CPF...', size: 20, skip_label: true %> 

      <%= f.primary t('menu.search') %>
    <% end %>
  </div>

  <div class='list1'>
    <% unless @taxpayers.nil? %>
      <div class='subtitle'> <%= 'Contribuintes Encontrados' %> </div>

      <% @taxpayers.each do |taxpayer| %>
        <li>
          <div class='strip' id='none'> <%= taxpayer.origin_code %> </div>

          <div class='indent'>
            <%= link_to(taxpayer.name, show_path(taxpayer)) %>
              &bull;
            <tt>
              <%= taxpayer.cpf %>
              &bull;
              <%= taxpayer.client.name if taxpayer.client %>
              &bull;
              <%= taxpayer.address %>
              &bull;
              <%= taxpayer.city.name if taxpayer.city %>
              &bull;
              <%= taxpayer.city.state if taxpayer.city %>
            </tt>
            <dt>
            </dt>
          </div>
        </li>
      <% end %>

      <% unless @taxpayers.empty? %>
        <div class="apple_pagination">
          <%= will_paginate @taxpayers, :container => false %>
        </div>
        <br>
      <% end %>

    <% end %>
  </div>



  <div class="row">

    <div class="col-md-6">
      <div class='subtitle'> <%= 'Lista de CNAs' %> </div>
      <table class="table">
        <thead>
          <tr>
            <th>Colaborador</th>
            <th>CNAS em Aberto</th>
            <th>Históricos Hoje</th>
            <th>Valores em Aberto</th>
          </tr>
        </thead>
        <tbody>
          <% unless @resume.nil? %>
            <% @resume.each do |r| %>
              <tr>
                <td><%= r.name %> </td>
                <td><%= r.count %> </td>
                <td><%= r.count_histories_today %> </td>
                <td><%= r.sum.real %> </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="col-md-3">
      <div class='subtitle'> <%= 'Termos Fechados no MES' %> </div>
      <table class="table">
        <thead>
          <tr>
            <th>Colaborador</th>
            <th>Termo(s)</th>
          </tr>
        </thead>
        <tbody>
          <% unless @count_contracts_month_master.nil? %>
            <% @count_contracts_month_master.each do |contract| %>
              <tr>
                <td><%= user_name contract[0] %> </td>
                <td><%= contract[1] %> </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="col-md-3">
      <div class='subtitle'> <%= 'Termos Fechados HOJE' %> </div>

       <table class="table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Termo(s)</th>
            </tr>
          </thead>
          <tbody>
            <% unless @count_contracts_day_master.nil? %>
              <% @count_contracts_day_master.each do |contract| %>
                <tr>
                  <td><%= user_name contract[0] %> </td>
                  <td><%= contract[1] %> </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class='subtitle'> <%= 'Últimos Históricos' %> </div>
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Contribuinte</th>
            <th>Colaborador</th>
            <th>Histórico</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% unless @histories.nil? %>
            <% @histories.each do |history| %>
              <tr>
                <td><%= history.created_at.to_s_br %> </td>
                <td><%= link_to(history.taxpayer.name, show_path(history.taxpayer)) if history.taxpayer.present? %> </td>
                <td><%= history.user.name if history.user.present? %> </td>
                <td><%= history.word.name if history.word.present? %> </td>
                <td><%= history.description %> </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>

  </div>
<% end  %>


<% if @taxpayer %>
  <div class="row marketing">
    <div class="col-sm-6 col-md-3">
      <div class="panel panel-primary">
        <%= render 'show_taxpayer' %> 
      </div>
    </div>

    <div class="col-sm-6 col-md-9">

      <div class='title_tools'>
        <% if Taxpayer.chargeble? @taxpayer %>
          <a class="btn btn-large btn-warning" <%= link_to(t('home.deal'), deal_url(cod: @taxpayer.id)) %> </a>
        <% else %>
          <a class="btn btn-large btn-danger"> <%= "Cidade não liberado para cobrança" %> </a>
        <% end %>
      </div>
      
      <div class='title_page'> <%= t('home.cna.title') %> </div>

      <table class="table">
        <thead>
          <tr>
            <th>Ano</th>
            <th>Valor CNA</th>
            <th>Meses</th>
            <th>Multa</th>
            <th>Juros</th>
            <th>Valor GUIA</th>
            <th><%= t('stage') %></th>
            <th><%= t('status') %></th>
            <th>Termo</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% unless @cnas.nil? %>
            <% @cnas.each do |cna| %>
              <tr>
                <td><%= cna.year %> </td>
                <td><%= cna.amount.real %> </td>
                <td><%= calc_meses_atraso(cna, nil, nil) %> </td>
                <td><%= calc_multa(cna, nil, nil).real %> </td>
                <td><%= calc_juros(cna, nil, nil).real %> </td>
                <td><%= calc_cna(cna, nil, nil).real %> </td>
                <td><%= t('cna.stage.'<<cna.stage) %> </td>
                <td><%= t('cna.status.'<<cna.status) %> </td>
                <td><%= cna.contract_id %> </td>
                <td><%= link_to('Marcar Pago', pay_cna_path(cna), method: :patch) if current_user.id == 1 and cna.not_pay? %> </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <td></td>
            <td><%= session[:value_cna].real %></td>
            <td></td>
            <td> <%= session[:total_multa].real %> </td>
            <td> <%= session[:total_juros].real %> </td>
            <td> <%= session[:total_cna].real %></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </tfoot>  
      </table>

      <div class='title_page'> <%= t('home.contract.title') %> </div>
      <table class="table">
        <thead>
          <tr>
            <th>Termo</th>
            <th>Situação</th>
            <th>Data Contrato</th>
            <th>Parcelas GMA</th>
            <th>Valor GMA</th>
            <th>Parcelas Federação</th>
            <th>Valor Federação</th>
          </tr>
        </thead>
        <tbody>
          <% if @contracts.nil? %>
            'Nenhum TERMO gerado para o contribuinte.'
          <% else %>
            <% @contracts.each do |contract| %>
              <tr>
                <td><%= contract.id %> </td>
                <% if contract.active? %>
                  <td><%= link_to(t('contract.status.' << contract.status) << ' - Ver Termo', contract_path(contract)) %> </td>
                <% else %>
                  <td><%= t('contract.status.' << contract.status) %></td>
                <% end %>
                <td><%= contract.contract_date.to_s_br %> </td>
                <td><%= contract.unit_ticket_quantity %> </td>
                <td><%= contract.unit_amount.real %> </td>
                <td><%= contract.client_ticket_quantity %> </td>
                <td><%= contract.client_amount.real %> </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
      <br>
      <br>
      <%= render 'histories' %>
      
    </div>
  </div>
<% end %>
